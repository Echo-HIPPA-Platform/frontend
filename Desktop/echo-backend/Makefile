# Mental Health Platform Backend Makefile

.PHONY: help build run test clean docker-up docker-down deps lint fmt

# Default target
help: ## Show this help message
	@echo "Mental Health Platform Backend - Available Commands:"
	@echo
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# Development commands
build: ## Build the application
	@echo "ğŸ”¨ Building application..."
	go build -o bin/server cmd/server/main.go
	@echo "âœ… Build complete!"

run: ## Run the application
	@echo "ğŸš€ Starting application..."
	go run cmd/server/main.go

dev: ## Run with hot reload (requires air)
	@echo "ğŸ”¥ Starting with hot reload..."
	air

test: ## Run tests
	@echo "ğŸ§ª Running tests..."
	go test -v ./...

test-coverage: ## Run tests with coverage
	@echo "ğŸ“Š Running tests with coverage..."
	go test -v -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report generated: coverage.html"

# Database commands
docker-up: ## Start PostgreSQL database
	@echo "ğŸ³ Starting PostgreSQL database..."
	docker-compose up -d postgres
	@echo "âœ… Database started on localhost:5432"

docker-down: ## Stop database
	@echo "ğŸ›‘ Stopping database..."
	docker-compose down

docker-logs: ## View database logs
	docker-compose logs -f postgres

db-connect: ## Connect to database
	docker exec -it mental-health-postgres psql -U postgres -d mental_health_platform

# Code quality commands
deps: ## Download dependencies
	@echo "ğŸ“¦ Downloading dependencies..."
	go mod download
	go mod tidy

lint: ## Run linter
	@echo "ğŸ” Running linter..."
	golangci-lint run

fmt: ## Format code
	@echo "ğŸ¨ Formatting code..."
	go fmt ./...
	goimports -w .

# Security commands
sec-scan: ## Run security scan
	@echo "ğŸ”’ Running security scan..."
	gosec ./...

vuln-check: ## Check for vulnerabilities
	@echo "ğŸ›¡ï¸ Checking for vulnerabilities..."
	govulncheck ./...

# API testing commands
api-test: ## Test API endpoints (requires running server)
	@echo "ğŸ§ª Testing API endpoints..."
	./test_api.sh

# Setup commands
setup: deps docker-up ## Setup development environment
	@echo "â³ Waiting for database to be ready..."
	sleep 10
	@echo "ğŸ‰ Development environment setup complete!"
	@echo "ğŸ“– Run 'make run' to start the server"
	@echo "ğŸ§ª Run 'make api-test' to test the API"

clean: ## Clean build artifacts
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf bin/
	rm -f coverage.out coverage.html

# Docker commands for full application
docker-build: ## Build Docker image
	@echo "ğŸ³ Building Docker image..."
	docker build -t mental-health-platform .

docker-run: ## Run application in Docker
	@echo "ğŸš€ Running application in Docker..."
	docker run -p 8080:8080 --env-file .env mental-health-platform

# Production helpers
prod-build: ## Build for production
	@echo "ğŸ­ Building for production..."
	CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -ldflags '-w -s' -o bin/server cmd/server/main.go

gen-jwt-secret: ## Generate a secure JWT secret
	@echo "ğŸ” Generated JWT Secret:"
	@openssl rand -base64 64

gen-password: ## Generate a secure password
	@echo "ğŸ”‘ Generated Password:"
	@openssl rand -base64 32

# Help for environment setup
env-help: ## Show environment setup help
	@echo "ğŸ“‹ Environment Setup:"
	@echo
	@echo "1. Copy .env file and update values:"
	@echo "   cp .env .env.local"
	@echo
	@echo "2. Update these required values in .env:"
	@echo "   - DB_USER=postgres"
	@echo "   - DB_PASSWORD=password"
	@echo "   - DB_NAME=mental_health_platform"
	@echo "   - JWT_SECRET=<generate with 'make gen-jwt-secret'>"
	@echo
	@echo "3. Start development:"
	@echo "   make setup"
	@echo "   make run"

info: ## Show project information
	@echo "ğŸ¥ Mental Health Platform Backend"
	@echo "ğŸ“‹ HIPAA-Compliant Authentication System"
	@echo
	@echo "ğŸ” Features:"
	@echo "  â€¢ JWT Authentication"
	@echo "  â€¢ Role-Based Access Control (RBAC)"
	@echo "  â€¢ Secure Password Hashing (bcrypt)"
	@echo "  â€¢ Comprehensive Audit Logging"
	@echo "  â€¢ Session Management"
	@echo "  â€¢ Security Headers"
	@echo
	@echo "ğŸ‘¥ User Roles:"
	@echo "  â€¢ Patient: Personal health data access"
	@echo "  â€¢ Doctor: Patient data access (authorized)"
	@echo "  â€¢ Admin: Full system administration"
	@echo
	@echo "ğŸ“š Documentation: README.md"
	@echo "ğŸ§ª API Testing: make api-test"
	@echo "ğŸƒ Quick Start: make setup && make run"

